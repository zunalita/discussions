name: Edit comment with link preview

on:
  discussion_comment:
    types: [created, edited]

permissions:
  discussions: write

jobs:
  unfurl:
    if: |
      (contains(github.event.comment.body, 'http://') || contains(github.event.comment.body, 'https://'))
      && !contains(github.event.comment.body, '<!-- unfurl-bot-start -->')
    runs-on: ubuntu-latest

    steps:
      - name: Validate links (syntax only)
        id: validate
        run: |
          BODY="${{ github.event.comment.body }}"

          CLEAN_BODY=$(echo "$BODY" | sed '/<!-- unfurl-bot-start -->/,/<!-- unfurl-bot-end -->/d')

          LINKS=$(echo "$CLEAN_BODY" | grep -Eo 'https?://[^[:space:]]+' | head -n 3)
          COUNT=$(echo "$LINKS" | wc -l)

          if [ "$COUNT" -eq 0 ]; then
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$COUNT" -gt 2 ]; then
            echo "Too many links ($COUNT). Skipping."
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          for URL in $LINKS; do
            if ! echo "$URL" | grep -Eq '^https?://[A-Za-z0-9.-]+\.[A-Za-z]{2,}(/.*)?$'; then
              echo "Invalid URL format: $URL"
              echo "run=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done

          echo "run=true" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Run unfurl action
        if: steps.validate.outputs.run == 'true'
        uses: zaorinu/unfurls-discussions@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          comment_id_numeric: ${{ github.event.comment.id }}
          comment_body: ${{ github.event.comment.body }}
          repo_owner: ${{ github.event.repository.owner.login }}
          repo_name: ${{ github.event.repository.name }}
          discussion_number: ${{ github.event.discussion.number }}
